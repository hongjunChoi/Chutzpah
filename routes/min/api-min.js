var express=require("express"),async=require("async"),router=express.Router(),mongoose=require("mongoose"),Post=mongoose.model("Post"),User=mongoose.model("User"),Comment=mongoose.model("Comment"),Event=mongoose.model("Event"),Chat=mongoose.model("Chat"),Like=mongoose.model("Like"),multer=require("multer"),bodyParser=require("body-parser"),path=require("path"),maxSize=1e7,storage=multer.diskStorage({destination:function(e,o,n){n(null,"./public/uploads/img/")},filename:function(e,o,n){n(null,e.session.username)}}),upload_file=multer({dest:"./public/uploads/",limits:{fileSize:maxSize}}).single("file"),upload_img=multer({storage:storage}).single("file");router.use(function(e,o,n){return"GET"===e.method?n():"undefined"!=typeof e.session.user&&"undefined"!=e.session.user&&null!=e.session.user&&e.session.user?n():o.redirect("/#login")}),router.route("/upload_file").post(function(e,o){console.log("-----file upload requested --------"),upload_file(e,o,function(e){return e?(console.log("Error: ",e),o.end("Error upoading file")):(console.log("upload success..."),o.json(o.req.file))})}),router.route("/upload_img").post(function(e,o){console.log("-----img upload requested --------"),upload_img(e,o,function(e){return e?(console.log("Error: ",e),o.end("Error upoading image")):(console.log("-----uploaded"),void o.send(200,"Success"))})}),router.route("/get_chat_from").get(function(e,o){console.log("--------get chat from -------");var n=e.query.sent_to,t=e.query.sent_from;Chat.find({$or:[{sent_to:n,sent_from:t},{sent_to:t,sent_from:n}]}).sort({sent_at:1}).exec(function(e,n){return e?o.send(500,e):o.send(200,n)})}),router.route("/comment").get(function(e,o){console.log("---------api");var n=e.query.post_id;Comment.find({post_id:n},function(e,n){return e?o.send(500,e):o.send(200,n)})}).post(function(e,o){console.log("------adding comment ");var n=new Comment;n.created_by=e.body.comment.created_by,n.text=e.body.comment.text,n.post_id=e.body.comment.post_id,n.save(function(e,n){return e?o.send(500,e):(console.log("comment saved"),void o.json(n))})}),router.route("/search").get(function(e,o){var n=e.query.search_string.trim();console.log(n);var t={artist_posts:[],files:[],artists:[],requests:[],events:[]};User.find({$or:[{created_by:n},{post_type:n},{username:n},{name:n}]},function(e,s){if(e)return o.send(e);var r=[];s.forEach(function(e){"artist"==e.user_type&&r.push(e)}),t.artists=r,Post.find({$or:[{created_by:n},{post_type:n},{text:n},{original_name:n}]},function(e,s){if(e)return o.send(e);var r=[],i=[],u=[];s.forEach(function(e){console.log(e),"artist"==e.user_type?e.is_file?r.push(e):i.push(e):e.is_request&&u.push(e)}),t.artist_posts=i,t.files=r,t.requests=u,Event.find({$or:[{artist:n},{venue:n},{location:n},{genre:n}]},function(e,n){return e?o.send(e):(t.events=n,void o.send(t))})})})}),router.route("/user").get(function(e,o){var n=e.query.username;User.find({username:n},function(e,n){return e?(console.log("err"),o.send(e)):o.json(n)})}),router.route("/profile").get(function(e,o){var n=e.query.username;console.log(n),result={posts:[],info:{}},User.find({username:n},function(e,t){return e?o.send(e):(result.info=t,void Post.find({created_by:n},function(e,n){return e?o.send(e):(result.posts=n,void o.send(result))}))})}),router.route("/gig_requests").get(function(e,o){console.log("adsfasdfasfddasfasdfasfasdf"),User.find({user_type:"venue"},function(e,n){return e?o.send(500,e):o.send(200,n)})}),router.route("/artists").get(function(e,o){User.find({user_type:"artist"},function(e,n){return e?o.send(500,e):(console.log(n),o.send(200,n))})}),router.route("/like").post(function(e,o){console.log(e.body);var n=e.body.post_id,t=e.body.created_by;Like.find({post_id:n,created_by:t},function(e,s){if(e&&o.send(500,e),0==s.length){var r=new Like;r.post_id=n,r.created_by=t,r.save(function(e,t){Post.findById(n,function(e,n){e&&o.send(500,e),"undefined"==typeof n.num_likes||0==n.num_likes?n.num_likes=1:n.num_likes=n.num_likes+1,n.save(function(e,n){e&&o.send(500,e),o.send(200,r)})})})}else o.send(200,"like already exists")})}),router.route("/events").post(function(e,o){var n=new Event;console.log(" ==== in creaing evtnt ======"),n.artist=e.body.artist,n.venue=e.body.venue,n.time=e.body.time,n.genre=e.body.genre,n.location=e.body.location,console.log(n.time),n.num_likes=0,n.save(function(e,n){return e?o.send(500,e):o.json(n)})}).get(function(e,o){Event.find(function(e,n){return e?o.send(500,e):o.send(200,n)})}),router.route("/posts").post(function(e,o){console.log("------post requested");var n=e.body.newPost,t=new Post;t.text=n.text,t.created_by=n.created_by,t.user_type=n.user_type,t.created_at=Date.now(),t.images=n.images,t.music_url=n.music_url,t.music_name=n.music_name,t.save(function(e,n){return e?o.send(500,e):o.json(n)})}).get(function(e,o){Post.find(function(e,n){return e?o.send(500,e):(final_posts=[],void async.each(n,function(e,n){var t=e._id;Like.find({post_id:t},function(t,s){t&&o.send(500,t);var r={};r.post_info=e,r.like_info=s,final_posts.push(r),n()})},function(e){e?console.log("ERROR IN GETTING LIKES & POSTS"):o.send(200,final_posts)}))})}),module.exports=router;