function set_columns(e,t,s){$("#col1").text(e),$("#col2").text(t),$("#col3").text(s)}function set_user_profile(e,t){var s=e.username,i=e.user_location,n=e.user_description,o=e.genre;set_user_images(e.image_url),$("#user_profile_username").html(s),$("#user_profile_location").html(i),$("#user_profile_description").html(n),$("#user_profile_genre").html(o),$(".current_user_profile").html(s),s==t?($("#openchat").hide(),$(".img-button").show()):($("#openchat").show(),$(".img-button").hide())}function set_user_images(e){"undefined"!=typeof e&&($("#userthumb").attr("src",e.substring(e.indexOf("/")+1)),$("#profile_image").attr("src",e.substring(e.indexOf("/")+1)))}function convert_time(e){var t=e.split("-")[0],s=e.split("-")[1],i=e.split("-")[2];i=i.split("T")[0];var e=e.split("T")[1],n=e.split(":")[0],o=e.split(":")[1],r=t+"/"+s+"/"+i+"     "+n+":"+o;return r}var app=angular.module("myApp",["ngRoute","ngResource"]).run(function(e,t){e.authenticated=!1,e.current_user="",e.now_playing={},e.search_string="",e.images_to_post=[],e.music_to_post="",t.get("/auth/session").success(function(t){t&&"undefined"!==t&&t.user&&(e.authenticated=!0,e.current_user=t.user.username,e.user_type=t.user.user_type,e.user=t.user,e.now_playing={created_by:e.current_user},set_user_images(e.user.img_url)),$("#mainscreen").data("username",e.current_user);var s=io.connect(),i=$("#mainscreen").data("username");s.emit("join",{username:i}),s.on("new_msg",function(t){if($("body").hasClass("chatopened")&&e.now_playing.created_by==t.from){var s=new Date;s=s.toString(),s=s.split(":")[0]+":"+s.split(":")[1];var i=t.music_type,n=t.location,o=t.time,r=t.id;if("request"==t.type){var a=" <div id = '"+r+"'class = 'chat_msg gig_request'> "+t.msg+"      by  "+t.from+"      at  "+s+"<div class = 'request_info'>  <p>requested song type :"+i+"</p> <p>requested gig time :"+o+"</p> <p>requested location :"+n+"</p></div> <div class = 'confirm_button'> CONFIRM </div> ";$(".chatmain").append(a),$("#"+r).data("request_info",t)}else{var a=" <div id = '"+r+"'class = 'chat_msg'> "+t.msg+"      by  "+t.from+"      at  "+s+"</div> ";$(".chatmain").append(a)}$(".chatmain").scrollTop($(".chatmain")[0].scrollHeight)}else alert(t.msg+"  received from "+t.from)})}),e.signout=function(){t.get("auth/signout"),e.authenticated=!1,e.current_user=""}});app.config(function(e){e.when("/login",{templateUrl:"login.html",controller:"authController"}).when("/signup",{templateUrl:"register.html",controller:"authController"})}),app.directive("fileModel",["$parse",function(e){return{restrict:"A",link:function(t,s,i){var n=e(i.fileModel),o=n.assign;s.bind("change",function(){t.$apply(function(){o(t,s[0].files[0])})})}}}]),app.service("fileUpload",["$http","$rootScope",function(e,t){this.uploadFileToUrl=function(t,s,i){var n=new FormData;n.append("file",t),e.post(s,n,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).then(function o(e){i(e.data)},function r(e){console.log(e)})},this.uploadImageToUrl=function(s,i){var n=new FormData;n.append("file",s),e.post(i,n,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).then(function o(e){console.log(e),set_user_images(e.data.img_url),t.user.image_url=e.data.img_url},function r(e){})}}]),app.controller("searchController",function(e,t,s){e.search_results={}}),app.factory("postService",function(e){return e("/api/posts/:id")}),app.controller("mainController",function(e,t,s,i,n){t.list_type=1;var o=[],r="/api/posts";n.get(r,{params:{user_type:"artist"}}).success(function(e){e.forEach(function(e){e.post_info.created_at=convert_time(e.post_info.created_at),o.push(e)}),s.artist_posts=o,$("#artistlist").hide(),$("#requestlist").hide(),$("#eventlist").hide()}),t.add_image=function(){$(".img-upload").click()},t.add_image_to_holder=function(){input=$(".img-upload"),file=input[0].files[0];var t="/api/upload_file";e.uploadFileToUrl(file,t,function(e){console.log(e);var t=e.path.substring(e.path.indexOf("/")+1);s.images_to_post.push(t)})},t.add_music=function(){$(".music-upload").click()},t.add_music_to_holder=function(){input=$(".music-upload"),file=input[0].files[0];var t="/api/upload_file";e.uploadFileToUrl(file,t,function(e){e.path=e.path.substring(e.path.indexOf("/")+1),s.music_to_post=e,$("#music-holder").empty(),console.log(e),$("#music-holder").append("<button>"+e.originalname+"</button>")})},t.trustSrc=function(e){return i.trustAsResourceUrl(e)},t.post=function(){var e=$("#text_input_field").val();if(""==e)return void $("#text_input_field").attr("placeholder","Please Write Something To Post!");t.newPost={},t.newPost.created_by=s.current_user,t.newPost.user_type=s.user_type,t.newPost.created_at=Date.now(),t.newPost.images=s.images_to_post,t.newPost.music_url=s.music_to_post.path,t.newPost.music_name=s.music_to_post.originalname,t.newPost.text=$("#text_input_field").val(),console.log(t.newPost);var i="/api/posts";n.post(i,{newPost:t.newPost}).success(function(e){$("#text_input_field").val(""),$("#music-holder").empty(),s.images_to_post=[],s.music_to_post="",t.refresh_view()})},t.refresh_view=function(){t.clear_lists();var e=$(".cat-checkbox:checked").val();1==e&&(set_columns("Posts","Artist","Date"),$("#artist_postlist").show(),$("#filelist").show(),""==s.search_string&&t.load_artist_posts()),2==e&&($("#artistlist").show(),set_columns("Artist","genre","description"),""==s.search_string&&t.load_artists()),3==e&&(set_columns("Venue Name","Location","Music preference"),""==s.search_string&&t.load_gig_requests(),$("#requestlist").show()),4==e&&(set_columns("Venue","Artist","Date"),""==s.search_string&&(t.load_gigs(),console.log(s.events)),$("#eventlist").show())},t.show_likes=function(e,t){alert(JSON.stringify(t))},t.like=function(e,t){var i="/api/like";n.post(i,{post_id:t._id,created_by:s.current_user}).success(function(t){if("like already exists"!=t){var s=$(e.target).closest(".post_like"),i=s.find(".like_count");console.log(s),console.log(i),console.log("===");var n=parseInt(i.html());i.html(n+1)}})},t.search=function(){return s.search_string=t.search_string,""==t.search_string?void t.refresh_view():void n.get("/api/search",{params:{search_string:t.search_string}}).success(function(e){for(var t=e.artist_posts,i=0;i<t.length;i++){var n=t[i].created_at;t[i].created_at=convert_time(n)}s.artist_posts=t;for(var i=0;i<e.files.length;i++)e.files[i].created_at=convert_time(e.files[i].created_at);s.files=e.files,s.artists=e.artists;for(var i=0;i<e.requests.length;i++)e.requests[i].created_at=convert_time(e.requests[i].created_at);s.requests=e.requests;for(var i=0;i<e.events.length;i++)e.events[i].time=convert_time(e.events[i].time);s.events=e.events})},t.open_profile=function(e){},t.show_event=function(e){},t.load_post_comments=function(e,i){s.now_playing.created_by=i.created_by;var o="/api/comment",r=i._id;t.post_id=r;var a=$(e.target).closest(".post-item");a.toggleClass("detailopened");var c=a.find(".commentField"),l=a.find(".commentmain");n.get(o,{params:{post_id:r}}).success(function(e){$("#commentmain").empty(),console.log("loading comments of clicked post : id ",c),console.log(e),console.log("=========="),l.empty(),e.forEach(function(e){l.append("<li>"+e.created_by+" said: "+e.text+" at : "+convert_time(e.created_at)+"</li>")}),c.show()})},t.clear_lists=function(){$("#artist_postlist").hide(),$("#filelist").hide(),$("#artistlist").hide(),$("#requestlist").hide(),$("#eventlist").hide()},t.get_now_playing=function(){var e=s.now_playing;"_id"in e?"block"==$("#now_playing_info_wrapper").css("display")?$("#now_playing_info_wrapper").hide():($("#upload_wrapper").hide(),$("#trending_wrapper").hide(),$("#saved_wrapper").hide(),$("#chat_list").hide(),t.set_now_playing_info(e),$("#now_playing_info_wrapper").show()):(alert("please choose music beforehand!"),$("#now_playing_info_wrapper").hide())},t.upload=function(){$("#now_playing_info_wrapper").hide(),$("#trending_wrapper").hide(),$("#saved_wrapper").hide(),$("#chat_list").hide(),$("#uploadwrapper").show();var s=t.myFile;if("undefined"==typeof s)return void $("#file_upload_form").val("");var i="/api/upload_file";e.uploadFileToUrl(s,i,function(e){t.refresh_view()})},t.upload_comment=function(e,t){var i=t._id;console.log("loading comment to post : id : ",i);var o="/api/comment",r=$(e.target).closest(".commentField"),a=r.find(".comment_input").val();n.post(o,{comment:{created_by:s.current_user,post_id:i,text:a}}).success(function(e){$(".comment_input").val("")})},t.load_artist_posts=function(){var e=[],t="/api/posts";n.get(t,{params:{user_type:"artist"}}).success(function(t){t.forEach(function(t){t.post_info.created_at=convert_time(t.post_info.created_at),e.push(t)}),s.artist_posts=e})},t.load_artists=function(){var e="/api/artists";n.get(e,{}).success(function(e){s.artists=e})},t.load_gig_requests=function(){var e="/api/gig_requests";n.get(e,{}).success(function(e){s.requests=e})},t.load_gigs=function(){var e="/api/events";n.get(e,{}).success(function(e){for(var t=0;t<e.length;t++)e[t].time=convert_time(e[t].time);s.events=e})},t.show_artist=function(e){},t.show_venue=function(e){},t.show_request=function(e){},t.show_event=function(e){},t.start_music=function(e){console.log("starting music"),$("body").removeClass("menuopened"),$("body").removeClass("profileopened"),$("body").removeClass("searchopened"),$("body").removeClass("chatopened");var i="/update_notification";$.post(i,{current_user:s.current_user}).done(function(e){console.log(e),console.log("NOTIFICATION TIME UPDATED")}),$("#jquery_jplayer_1").jPlayer("setMedia",{title:e.original_name,mp3:e.url.substring(e.url.indexOf("/")+1)}),t.post_id=e._id,t.load_comments(e),s.now_playing=e,$("body").addClass("menuopened"),$("#now_playing_info_wrapper").hide(),t.get_now_playing()},t.set_now_playing_info=function(e){$("#now_playing_song_title").html(e.original_name),$("#now_playing_song_artist").html(e.created_by),$("#now_playing_song_date").html(e.created_at);var t="/api/user",s=e.created_by;console.log("-------setnow"),n.get(t,{params:{username:s}}).success(function(e){e.length>0&&set_user_images(e[0].img_url)})}}),app.controller("profileController",function(e,t,s,i){function n(e){$(".chatmain").empty();for(var t=0;t<e.length;t++){var i=e[t],n=convert_time(i.sent_at),o=i.request_music_type,r=i.request_location,a=i.request_time,c=i._id;if("request"==i.chat_type){var l="";l=i.sent_from==s.current_user?" <div class = 'chat_msg gig_request'> successfully send gig request to  "+i.sent_to+"    <div class = 'request_info'>  <p>requested song type :"+o+"</p> <p>requested gig time :"+a+"</p> <p>requested location :"+r+"</p></div>":" <div id = '"+c+"'  class = 'chat_msg gig_request'> "+i.chat_text+"      by  "+i.sent_from+"      at  "+n+"<div class = 'request_info'>  <p>requested song type :"+o+"</p> <p>requested gig time :"+a+"</p> <p>requested location :"+r+"</p></div> <div class = 'confirm_button'> CONFIRM </div> ",$(".chatmain").append(l),$("#"+c).data("request_info",i)}else{var l=" <div id = '"+c+"'class = 'chat_msg'> "+i.chat_text+"      by  "+i.sent_from+"      at  "+n+"</div> ";$(".chatmain").append(l)}}}t.user_posts=[],t.user_info={},t.get_profile_info=function(){var e="/api/profile",n=s.now_playing.created_by;i.get(e,{params:{username:n}}).success(function(e){var i=e.info;set_user_profile(i[0],s.current_user);var n=e.posts;t.user_info=i,t.user_posts=n,$("#user_post_wrapper").empty(),$("body").addClass("profileopened"),n.forEach(function(e){var t=convert_time(e.created_at),s=e.is_file,i,n="profile_post_"+e._id;i="true"==s||1==s?"<li class = 'profile_post_item' id ='"+n+"' style = 'display:block'><h6>"+e.original_name+" </h6> <p>"+t+"</p> <p>"+e.created_by+"</p></li>":"<li class = 'profile_post_item' id = '"+n+"' style = 'display:block'><h6>"+e.text+" </h6> <p>"+t+"</p> <p>"+e.created_by+"</p></li>",$("#user_post_wrapper").append(i),$("#"+n).data("profile_post",e)})})},t.upload_image=function(){$(".file-upload").on("change",function(){t.readURL()}),$(".file-upload").click()},t.readURL=function(){var s=t.imgFile,i="/api/upload_img";e.uploadImageToUrl(s,i)},t.get_chat=function(){$("#now_playing_info_wrapper").hide(),$("#trending_wrapper").hide(),$("#saved_wrapper").hide(),"block"==$("#chat_list").css("display")?$("#chat_list").hide():$("#chat_list").show(),i.get("/get_chat",{params:{user_name:s.current_user}}).success(function(e){for(var t=e.newchat,s=e.oldchat,i={},n=0;n<t.length;n++){var o=t[n],r=o.sent_from;if(r in i)i[r].chats.push(o);else{var a=[];a.push(o),i[r]={chats:a,count:0}}}for(var n=0;n<s.length;n++){var o=s[n],r=o.sent_from;if(r in i)i[r].chats.push(o),i[r].count=i[r].count+1;else{var a=[];a.push(o),i[r]={chats:a,count:1}}}console.log("====== this data is saved as data attribute on notification chats for toggle ======"),console.log(i);var c=0,l=Object.keys(i);$("#chat_list").empty();for(var n=0;n<l.length;n++){var u=l[n],_=i[u].count;c+=_;var p="chat_"+u,o="<li class = 'chat_list_item' id = "+p+">"+u+"   <span id = 'new_chat_count'> "+_+"</span> </li>";$("#chat_list").append(o),$("#"+p).data("chats",i[u])}$("#new_message_num").html(c)})},t.get_chat_from=function(){i.get("api/get_chat_from",{params:{sent_from:s.now_playing.created_by,sent_to:s.current_user}}).success(function(e){n(e),$("body").addClass("chatopened"),$(".chatmain").scrollTop($(".chatmain")[0].scrollHeight);var t="/update_notification";$.post(t,{current_user:s.current_user}).done(function(e){console.log(e),console.log("NOTIFICATION TIME UPDATED")})})},t.send_request=function(){var e="/send_chat",t=s.now_playing.created_by,n=$("#chat_input").val(),o=s.current_user;i.post(e,{chat_type:"request",sent_from:o,text:n,sent_to:t,request_music_type:"sample genre",request_location:"providence mall",request_time:Date.now()}).success(function(e){$("#chat_input").val("");var s=e.request_music_type,i=convert_time(e.request_time),n=e.request_location,o=" <div class = 'chat_msg gig_request'> successfully send gig request to  "+t+"    <div class = 'request_info'>  <p>requested song type :"+s+"</p> <p>requested gig time :"+i+"</p> <p>requested location :"+location+"</p></div>";$(".chatmain").append(o),$(".chatmain").scrollTop($(".chatmain")[0].scrollHeight)})},t.send_chat=function(){var e="/send_chat",t=s.now_playing.created_by,n=$("#chat_input").val(),o=s.current_user;i.post(e,{chat_type:"msg",sent_from:o,text:n,sent_to:t}).success(function(e){var t=e.sent_at;t=convert_time(t),$("#chat_input").val("");var s=" <div class = 'mychat_msg chat_msg'> "+n+"      at  "+t+"</div> ";$(".chatmain").append(s),$(".chatmain").scrollTop($(".chatmain")[0].scrollHeight)})}}),app.controller("authController",function(e,t,s,i){e.user={username:"",password:"",location:"",bandname:"",genre:"",user_type:""},e.error_message="",e.login=function(){t.post("/auth/login",e.user).success(function(t){"success"==t.state?(s.authenticated=!0,s.current_user=t.user.username,s.user_type=t.user.user_type,i.path("/profile")):e.error_message=t.message})},e.change_user_type=function(){$("#register_musician").hide(),$("#register_host").hide(),$("#register_fan").hide();var e=$(".user-checkbox:checked").val();1==e&&$("#register_musician").show(),2==e&&$("#register_host").show(),3==e&&$("#register_fan").show()},e.register=function(){var s=$(".user-checkbox:checked").val();1==s&&(e.user.user_type="artist"),2==s&&(e.user.user_type="venue"),3==s&&(e.user.user_type="fan"),t.post("/auth/signup",e.user).success(function(t){"success"==t.state?(alert("email-verification sent!"),i.path("/")):e.error_message=t.message})}});