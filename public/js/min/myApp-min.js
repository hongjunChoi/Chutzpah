function set_columns(e,t,s){$("#col1").text(e),$("#col2").text(t),$("#col3").text(s)}function set_user_profile(e,t){var s=e.username,n=e.user_location,i=e.user_description,r=e.genre;set_user_images(e.image_url),$("#user_profile_username").html(s),$("#user_profile_location").html(n),$("#user_profile_description").html(i),$("#user_profile_genre").html(r),$(".current_user_profile").html(s),s==t?($("#openchat").hide(),$(".img-button").show()):($("#openchat").show(),$(".img-button").hide())}function set_user_images(e){"undefined"!=typeof e&&($("#userthumb").attr("src",e.substring(e.indexOf("/")+1)),$("#profile_image").attr("src",e.substring(e.indexOf("/")+1)))}function convert_time(e){var t=e.split("-")[0],s=e.split("-")[1],n=e.split("-")[2];n=n.split("T")[0];var e=e.split("T")[1],i=e.split(":")[0],r=e.split(":")[1],a=t+"/"+s+"/"+n+"     "+i+":"+r;return a}var app=angular.module("myApp",["ngRoute","ngResource"]).run(function(e,t){e.authenticated=!1,e.current_user="",e.now_playing={},e.search_string="",t.get("/auth/session").success(function(t){t&&"undefined"!==t&&t.user&&(e.authenticated=!0,e.current_user=t.user.username,e.user_type=t.user.user_type,e.user=t.user,e.now_playing={created_by:e.current_user},set_user_images(e.user.img_url)),$("#mainscreen").data("username",e.current_user);var s=io.connect(),n=$("#mainscreen").data("username");s.emit("join",{username:n}),s.on("new_msg",function(t){if($("body").hasClass("chatopened")&&e.now_playing.created_by==t.from){var s=new Date;s=s.toString(),s=s.split(":")[0]+":"+s.split(":")[1];var n=t.music_type,i=t.location,r=t.time,a=t.id;if("request"==t.type){var o=" <div id = '"+a+"'class = 'chat_msg gig_request'> "+t.msg+"      by  "+t.from+"      at  "+s+"<div class = 'request_info'>  <p>requested song type :"+n+"</p> <p>requested gig time :"+r+"</p> <p>requested location :"+i+"</p></div> <div class = 'confirm_button'> CONFIRM </div> ";$(".chatmain").append(o),$("#"+a).data("request_info",t)}else{var o=" <div id = '"+a+"'class = 'chat_msg'> "+t.msg+"      by  "+t.from+"      at  "+s+"</div> ";$(".chatmain").append(o)}$(".chatmain").scrollTop($(".chatmain")[0].scrollHeight)}else alert(t.msg+"  received from "+t.from)})}),e.signout=function(){t.get("auth/signout"),e.authenticated=!1,e.current_user=""}});app.config(function(e){e.when("/login",{templateUrl:"login.html",controller:"authController"}).when("/signup",{templateUrl:"register.html",controller:"authController"})}),app.directive("fileModel",["$parse",function(e){return{restrict:"A",link:function(t,s,n){var i=e(n.fileModel),r=i.assign;s.bind("change",function(){t.$apply(function(){r(t,s[0].files[0])})})}}}]),app.service("fileUpload",["$http","$rootScope",function(e,t){this.uploadFileToUrl=function(t,s,n){var i=new FormData;i.append("file",t),alert("file upload"),e.post(s,i,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).then(function r(e){$("#file_upload_form").val(""),n()},function a(e){console.log("123432r")})},this.uploadImageToUrl=function(s,n){var i=new FormData;i.append("file",s),e.post(n,i,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).then(function r(e){console.log(e),set_user_images(e.data.img_url),t.user.image_url=e.data.img_url},function a(e){})}}]),app.controller("searchController",function(e,t,s){e.search_results={}}),app.factory("postService",function(e){return e("/api/posts/:id")}),app.controller("mainController",function(e,t,s,n,i){t.list_type=1;var r=[],a=[],o="/api/posts";i.get(o,{params:{user_type:"artist"}}).success(function(e){e.forEach(function(e){1==e.post_info.is_file||"true"==e.post_info.is_file?(e.post_info.created_at=convert_time(e.post_info.created_at),r.push(e)):(e.post_info.created_at=convert_time(e.post_info.created_at),a.push(e))}),s.artist_posts=a,s.files=r,$("#artistlist").hide(),$("#requestlist").hide(),$("#eventlist").hide()}),t.trustSrc=function(e){return n.trustAsResourceUrl(e)},t.post=function(){t.newPost.created_by=s.current_user,t.newPost.user_type=s.user_type,t.newPost.created_at=Date.now(),console.log("----------"),console.log(t.newPost);var e="/api/posts";i.post(e,{newPost:t.newPost}).success(function(e){$("#post_input_field").val(""),t.refresh_view()})},t.refresh_view=function(){t.clear_lists();var e=$(".cat-checkbox:checked").val();1==e&&(set_columns("Song","Artist","Date"),$("#artist_postlist").show(),$("#filelist").show(),""==s.search_string&&t.load_artist_posts()),2==e&&($("#artistlist").show(),set_columns("Artist","genre","description"),""==s.search_string&&t.load_artists()),3==e&&(set_columns("Gig requests","Venue","Date"),""==s.search_string&&t.load_gig_requests(),$("#requestlist").show()),4==e&&(set_columns("Venue","Artist","Date"),""==s.search_string&&(t.load_gigs(),console.log(s.events)),$("#eventlist").show())},t.show_likes=function(e,t){alert(JSON.stringify(t))},t.like=function(e,t){var n="/api/like";i.post(n,{post_id:t._id,created_by:s.current_user}).success(function(t){if("like already exists"!=t){var s=$(e.target).closest(".post_like"),n=s.find(".like_count");console.log(s),console.log(n),console.log("===");var i=parseInt(n.html());n.html(i+1)}})},t.search=function(){return s.search_string=t.search_string,""==t.search_string?void t.refresh_view():void i.get("/api/search",{params:{search_string:t.search_string}}).success(function(e){for(var t=e.artist_posts,n=0;n<t.length;n++){var i=t[n].created_at;t[n].created_at=convert_time(i)}s.artist_posts=t;for(var n=0;n<e.files.length;n++)e.files[n].created_at=convert_time(e.files[n].created_at);s.files=e.files,s.artists=e.artists;for(var n=0;n<e.requests.length;n++)e.requests[n].created_at=convert_time(e.requests[n].created_at);s.requests=e.requests;for(var n=0;n<e.events.length;n++)e.events[n].time=convert_time(e.events[n].time);s.events=e.events})},t.open_profile=function(e){},t.show_event=function(e){},t.load_post_comments=function(e){s.now_playing.created_by=e.created_by;var n="/api/comment",r=e._id;t.post_id=r,i.get(n,{params:{post_id:r}}).success(function(e){$("#commentmain").empty(),e.forEach(function(e){$("#commentmain").append("<li>"+e.created_by+" said: "+e.text+" at : "+convert_time(e.created_at)+"</li>")}),$(".commentField").show()})},t.clear_lists=function(){$("#artist_postlist").hide(),$("#filelist").hide(),$("#artistlist").hide(),$("#requestlist").hide(),$("#eventlist").hide()},t.get_now_playing=function(){var e=s.now_playing;"_id"in e?"block"==$("#now_playing_info_wrapper").css("display")?$("#now_playing_info_wrapper").hide():($("#upload_wrapper").hide(),$("#trending_wrapper").hide(),$("#saved_wrapper").hide(),$("#chat_list").hide(),t.set_now_playing_info(e),$("#now_playing_info_wrapper").show()):(alert("please choose music beforehand!"),$("#now_playing_info_wrapper").hide())},t.upload=function(){$("#now_playing_info_wrapper").hide(),$("#trending_wrapper").hide(),$("#saved_wrapper").hide(),$("#chat_list").hide(),$("#uploadwrapper").show();var s=t.myFile;if("undefined"==typeof s)return void $("#file_upload_form").val("");var n="/api/upload_file";e.uploadFileToUrl(s,n,function(e){t.refresh_view()})},t.upload_comment=function(){var e="/api/comment";t.comment.created_by=s.current_user,t.comment.post_id=t.post_id,i.post(e,{comment:t.comment}).success(function(e){$("#comment_input").val("")})},t.load_artist_posts=function(){var e=[],t=[],n="/api/posts";i.get(n,{params:{user_type:"artist"}}).success(function(n){n.forEach(function(s){1==s.post_info.is_file||"true"==s.post_info.is_file?(s.post_info.created_at=convert_time(s.post_info.created_at),e.push(s)):(s.post_info.created_at=convert_time(s.post_info.created_at),t.push(s))}),s.artist_posts=t,s.files=e})},t.load_artists=function(){var e="/api/artists";i.get(e,{}).success(function(e){s.artists=e})},t.load_gig_requests=function(){var e="/api/gig_requests";i.get(e,{}).success(function(e){s.requests=e})},t.load_gigs=function(){var e="/api/events";i.get(e,{}).success(function(e){for(var t=0;t<e.length;t++)e[t].time=convert_time(e[t].time);s.events=e})},t.load_comments=function(e){var s=e._id,n="/api/comment";t.post_id=s,i.get(n,{params:{post_id:s}}).success(function(e){return $("#commentmain").empty(),e.forEach(function(e){$("#commentmain").append("<li>"+e.created_by+" said: "+e.text+" at : "+convert_time(e.created_at)+"</li>")}),$(".commentField").show(),e})},t.show_artist=function(e){},t.show_venue=function(e){},t.show_request=function(e){},t.show_event=function(e){},t.start_music=function(e){console.log("starting music"),$("body").removeClass("menuopened"),$("body").removeClass("profileopened"),$("body").removeClass("searchopened"),$("body").removeClass("chatopened");var n="/update_notification";$.post(n,{current_user:s.current_user}).done(function(e){console.log(e),console.log("NOTIFICATION TIME UPDATED")}),$("#jquery_jplayer_1").jPlayer("setMedia",{title:e.original_name,mp3:e.url.substring(e.url.indexOf("/")+1)}),t.post_id=e._id,t.load_comments(e),s.now_playing=e,$("body").addClass("menuopened"),$("#now_playing_info_wrapper").hide(),t.get_now_playing()},t.set_now_playing_info=function(e){$("#now_playing_song_title").html(e.original_name),$("#now_playing_song_artist").html(e.created_by),$("#now_playing_song_date").html(e.created_at);var t="/api/user",s=e.created_by;console.log("-------setnow"),i.get(t,{params:{username:s}}).success(function(e){e.length>0&&set_user_images(e[0].img_url)})}}),app.controller("profileController",function(e,t,s,n){function i(e){$(".chatmain").empty();for(var t=0;t<e.length;t++){var n=e[t],i=convert_time(n.sent_at),r=n.request_music_type,a=n.request_location,o=n.request_time,c=n._id;if("request"==n.chat_type){var _="";_=n.sent_from==s.current_user?" <div class = 'chat_msg gig_request'> successfully send gig request to  "+n.sent_to+"    <div class = 'request_info'>  <p>requested song type :"+r+"</p> <p>requested gig time :"+o+"</p> <p>requested location :"+a+"</p></div>":" <div id = '"+c+"'  class = 'chat_msg gig_request'> "+n.chat_text+"      by  "+n.sent_from+"      at  "+i+"<div class = 'request_info'>  <p>requested song type :"+r+"</p> <p>requested gig time :"+o+"</p> <p>requested location :"+a+"</p></div> <div class = 'confirm_button'> CONFIRM </div> ",$(".chatmain").append(_),$("#"+c).data("request_info",n)}else{var _=" <div id = '"+c+"'class = 'chat_msg'> "+n.chat_text+"      by  "+n.sent_from+"      at  "+i+"</div> ";$(".chatmain").append(_)}}}t.user_posts=[],t.user_info={},t.get_profile_info=function(){var e="/api/profile",i=s.now_playing.created_by;n.get(e,{params:{username:i}}).success(function(e){var n=e.info;set_user_profile(n[0],s.current_user);var i=e.posts;t.user_info=n,t.user_posts=i,$("#user_post_wrapper").empty(),$("body").addClass("profileopened"),i.forEach(function(e){var t=convert_time(e.created_at),s=e.is_file,n,i="profile_post_"+e._id;n="true"==s||1==s?"<li class = 'profile_post_item' id ='"+i+"' style = 'display:block'><h6>"+e.original_name+" </h6> <p>"+t+"</p> <p>"+e.created_by+"</p></li>":"<li class = 'profile_post_item' id = '"+i+"' style = 'display:block'><h6>"+e.text+" </h6> <p>"+t+"</p> <p>"+e.created_by+"</p></li>",$("#user_post_wrapper").append(n),$("#"+i).data("profile_post",e)})})},t.upload_image=function(){$(".file-upload").on("change",function(){t.readURL()}),$(".file-upload").click()},t.readURL=function(){var s=t.imgFile,n="/api/upload_img";e.uploadImageToUrl(s,n)},t.get_chat=function(){$("#now_playing_info_wrapper").hide(),$("#trending_wrapper").hide(),$("#saved_wrapper").hide(),"block"==$("#chat_list").css("display")?$("#chat_list").hide():$("#chat_list").show(),n.get("/get_chat",{params:{user_name:s.current_user}}).success(function(e){for(var t=e.newchat,s=e.oldchat,n={},i=0;i<t.length;i++){var r=t[i],a=r.sent_from;if(a in n)n[a].chats.push(r);else{var o=[];o.push(r),n[a]={chats:o,count:0}}}for(var i=0;i<s.length;i++){var r=s[i],a=r.sent_from;if(a in n)n[a].chats.push(r),n[a].count=n[a].count+1;else{var o=[];o.push(r),n[a]={chats:o,count:1}}}console.log("====== this data is saved as data attribute on notification chats for toggle ======"),console.log(n);var c=0,_=Object.keys(n);$("#chat_list").empty();for(var i=0;i<_.length;i++){var u=_[i],l=n[u].count;c+=l;var p="chat_"+u,r="<li class = 'chat_list_item' id = "+p+">"+u+"   <span id = 'new_chat_count'> "+l+"</span> </li>";$("#chat_list").append(r),$("#"+p).data("chats",n[u])}$("#new_message_num").html(c)})},t.get_chat_from=function(){n.get("api/get_chat_from",{params:{sent_from:s.now_playing.created_by,sent_to:s.current_user}}).success(function(e){i(e),$("body").addClass("chatopened"),$(".chatmain").scrollTop($(".chatmain")[0].scrollHeight);var t="/update_notification";$.post(t,{current_user:s.current_user}).done(function(e){console.log(e),console.log("NOTIFICATION TIME UPDATED")})})},t.send_request=function(){var e="/send_chat",t=s.now_playing.created_by,i=$("#chat_input").val(),r=s.current_user;n.post(e,{chat_type:"request",sent_from:r,text:i,sent_to:t,request_music_type:"sample genre",request_location:"providence mall",request_time:Date.now()}).success(function(e){$("#chat_input").val("");var s=e.request_music_type,n=convert_time(e.request_time),i=e.request_location,r=" <div class = 'chat_msg gig_request'> successfully send gig request to  "+t+"    <div class = 'request_info'>  <p>requested song type :"+s+"</p> <p>requested gig time :"+n+"</p> <p>requested location :"+location+"</p></div>";$(".chatmain").append(r),$(".chatmain").scrollTop($(".chatmain")[0].scrollHeight)})},t.send_chat=function(){var e="/send_chat",t=s.now_playing.created_by,i=$("#chat_input").val(),r=s.current_user;n.post(e,{chat_type:"msg",sent_from:r,text:i,sent_to:t}).success(function(e){var t=e.sent_at;t=convert_time(t),$("#chat_input").val("");var s=" <div class = 'mychat_msg chat_msg'> "+i+"      at  "+t+"</div> ";$(".chatmain").append(s),$(".chatmain").scrollTop($(".chatmain")[0].scrollHeight)})}}),app.controller("authController",function(e,t,s,n){e.user={username:"",password:"",location:"",bandname:"",genre:"",user_type:""},e.error_message="",e.login=function(){t.post("/auth/login",e.user).success(function(t){"success"==t.state?(s.authenticated=!0,s.current_user=t.user.username,s.user_type=t.user.user_type,n.path("/profile")):e.error_message=t.message})},e.change_user_type=function(){$("#register_musician").hide(),$("#register_host").hide(),$("#register_fan").hide();var e=$(".user-checkbox:checked").val();1==e&&$("#register_musician").show(),2==e&&$("#register_host").show(),3==e&&$("#register_fan").show()},e.register=function(){var s=$(".user-checkbox:checked").val();1==s&&(e.user.user_type="artist"),2==s&&(e.user.user_type="venue"),3==s&&(e.user.user_type="fan"),t.post("/auth/signup",e.user).success(function(t){"success"==t.state?(alert("email-verification sent!"),n.path("/")):e.error_message=t.message})}});